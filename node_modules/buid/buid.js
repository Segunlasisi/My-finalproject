"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=exports.defaults=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_fs=require("fs"),_path=require("path"),_services=require("./services");function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var defaults={chain:["criteria","requirementGroups","requirements","optionDetails","optionGroups","options"],fix:!1,skip:["optionDetails"],segmentLength:2,verbose:!1};exports.defaults=defaults;var buid=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b&&"path"in b){a.next=2;break}throw new ReferenceError("You must specify a path to the file or an object to be validated.");case 2:return c=b.path,d=b.chain,e=void 0===d?defaults.chain:d,f=b.fix,g=void 0===f?defaults.fix:f,h=b.skip,i=void 0===h?defaults.skip:h,j=b.segmentLength,k=void 0===j?defaults.segmentLength:j,l=b.verbose,m=void 0===l?defaults.verbose:l,n=b.cli,o=void 0!==n&&n,p=new _services.Util,q=p.inArray,r=p.isObject,s=p.isArray,t=p.pastZero,u=new _services.Logger(m),v=u.verboseLog,w=u.systemLog,x=e.reduce(function(a,b,c){return Object.assign(a,(0,_defineProperty2["default"])({},b,q(i,b)?e[c+1]:b))},{}),y=Array.from(new Set(Object.values(x))),z=y.length*k,A="object"===(0,_typeof2["default"])(c)?c:JSON.parse((0,_fs.readFileSync)(c).toString()),B=[],w("\nReading ".concat(c,".\n")),C=function(a){return(null===e||void 0===e?void 0:e[e.indexOf(a)+1])||null},D=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,f,h,j,l,m,n,o,p,u,A,E,F,G,H;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=b.node,d=b.prevPath,f=void 0===d?null:d,h=b.currentPath,j=b.index,l=b.parent,m=C(h),!s(c)){a.next=4;break}return a.abrupt("return",Promise.all(c.map(function(a,b){return D({node:a,prevPath:h,currentPath:m,index:b+1,parent:l})})));case 4:if(!r(c)){a.next=61;break}if(n=t(y.indexOf(x[h||f])*k-(h?k:0)),o=c.id,p=new _services.Generator({depth:n,segmentLength:k}),u=p.insertIndexAt,A=p.modifyId,E=p.normalizeIndex,h!==e[0]&&"id"in c&&c.id.length&&(v("Validating element ".concat(c.id," identificator.")),c.id.length!==z&&(o=A(c.id,n,function(){return j}),B.push("Element id ".concat(c.id," should be of length ").concat(z,"."))),F=c.id.slice(n,n+k),+F!==j&&(o=A(c.id,n,function(){return j}),B.push("Element id ".concat(c.id," at position [").concat(n/k+1,", ").concat(F,"] should be equal to ").concat(E(j),"."))),G=c.id.slice(n+k),G.split("").some(function(a){return"0"!==a})&&(o=u({start:c.id,end:c.id,index:j}),B.push("Element id ".concat(c.id," contains excess symbols."))),"id"in l&&c.id.slice(0,n)!==l.id.slice(0,n)&&(o=u({start:l.id,end:c.id,index:j}),B.push("Element id ".concat(c.id," should correctly inherit parent id ").concat(l.id,".")))),"id"in c&&c.id.length||(o=l&&"id"in l&&f!==e[0]?A(l.id,n,function(){return j}):A("0".repeat(z),0,function(){return j}),g?w("Generated an id for element ".concat(o,".")):B.push("Encountered missing or empty id at ".concat(h).concat((null===l||void 0===l?void 0:l.id)?" ".concat(l.id):"","."))),(null===c||void 0===c?void 0:c.id)&&c.id.length&&o!==c.id&&g&&w("Fixed element id ".concat(c.id," -> ").concat(o,".")),H=_objectSpread(_objectSpread({},c),{},{id:o}),h){a.next=14;break}return a.abrupt("return",H);case 14:if(!q(i,h)){a.next=49;break}if(!(h in c)){a.next=48;break}if(v("Skipping ".concat(h,".\n")),!s(c[h])){a.next=29;break}return a.t0=_objectSpread,a.t1=_objectSpread({},H),a.t2={},a.t3=_defineProperty2["default"],a.t4={},a.t5=h,a.next=26,Promise.all(c[h].map(function(a){return D({node:a[h][m],prevPath:f,currentPath:m,parent:H})}));case 26:return a.t6=a.sent,a.t7=(0,a.t3)(a.t4,a.t5,a.t6),a.abrupt("return",(0,a.t0)(a.t1,a.t2,a.t7));case 29:return a.t8=_objectSpread,a.t9=_objectSpread({},H),a.t10={},a.t11=_defineProperty2["default"],a.t12={},a.t13=h,a.t14=_objectSpread,a.t15=_objectSpread({},c[h]),a.t16={},a.t17=_defineProperty2["default"],a.t18={},a.t19=m,a.next=43,D({node:c[h][m],prevPath:f,currentPath:m,parent:H});case 43:return a.t20=a.sent,a.t21=(0,a.t17)(a.t18,a.t19,a.t20),a.t22=(0,a.t14)(a.t15,a.t16,a.t21),a.t23=(0,a.t11)(a.t12,a.t13,a.t22),a.abrupt("return",(0,a.t8)(a.t9,a.t10,a.t23));case 48:return a.abrupt("return",H);case 49:if(!s(c[h])){a.next=61;break}return a.t24=_objectSpread,a.t25=_objectSpread({},H),a.t26={},a.t27=_defineProperty2["default"],a.t28={},a.t29=h,a.next=58,Promise.all(c[h].map(function(a,b){return D({node:a,prevPath:h,currentPath:m,index:b+1,parent:H})}));case 58:return a.t30=a.sent,a.t31=(0,a.t27)(a.t28,a.t29,a.t30),a.abrupt("return",(0,a.t24)(a.t25,a.t26,a.t31));case 61:console.log("\n");case 62:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),w("Starting validation process...\n"),a.next=16,D({node:A,currentPath:e[0]});case 16:if(E=a.sent,!g){a.next=21;break}return o&&(F="fixed".concat(c.slice(c.lastIndexOf("."))),(0,_fs.writeFileSync)((0,_path.resolve)(__dirname,F),JSON.stringify(E,null,2)),w("\nWrote fixed result to a file ".concat(__dirname,"/").concat(F,"."))),w("\nFinished validation process."),a.abrupt("return",E);case 21:if(!B.length){a.next=25;break}throw new SyntaxError(JSON.stringify(B,null,2));case 25:w("No errors found.\n");case 26:w("\nFinished validation process.");case 27:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),_default=buid;exports["default"]=_default;